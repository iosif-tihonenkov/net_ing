# BGP

## Два вида протокола

### IGP

IGP является внутренним протоколом (по отношению к моей AS — автономной системе)

Внутренние протоколы я уже проходил — это EIGRP, OSPF. Еще не проходил — ISIS, RIP.

### EGP

EGP  является внешним протоколом.
Представляет только один протокол — EBGP или BGP (что проще — не «ебижипи» же?)

BGP обеспечивает передачу маршрутов между различными сетями (AS).

Что такое AS — это система IP-сетей и маршрутизаторов, управляемых одним или несколькими операторами, имеющими единую пполитику маршрутизации с интернетом. 

## Дальнейшее деление
<img width="1065" height="758" alt="image" src="https://github.com/user-attachments/assets/64b2faae-4965-4c66-bdd6-c0d0fb3d4ffe" />
### iBGP
iBGP — необходим для передачи BGP-маршрутов внутри одной AS

### EBGP
EBGP — BGP МЕЖДУ AS

## Сходства

1. Оба опираются на один из двух алгоритмов — DV (distance vector — протокол дистанционно-векторной маршрутизаии) или LS (link state — протокол основанный на LS — пара «соседство-стоимость».


## Как устанавливается соедининение

Два устройства, между которыми установлена BGP-сессия — BGP-пиры или BGP-соседи

Эти соседи не устанавливаются автоматически. Их необходимо настроить вручную. 

1. Изначальное состояние BGP-соседства — IDLE (ничего не происходит). В этом состоянии BGP находится в случае, если нет маршрута к BGP-пиру.

Посмотреть состояние можно по команде `show ip bgp neighbor`.
<img width="846" height="775" alt="image" src="https://github.com/user-attachments/assets/634dcd82-5305-46cb-8b03-cbad3efbbf2c" />


2. Для надежности BGP использует TCP (мы как то обсуждали, что это хоть не самый быстрый, но надежный протокол. Его брат — UDP (по ходу приемный)).


BGP-маршрутизатор слушаеn и посылает пакеты на 179 TCP порт.
<img width="669" height="129" alt="image" src="https://github.com/user-attachments/assets/5928d0cf-9149-4ee8-8d9c-ab03cf54535c" />


Когда слушает — состояние CONNECT. 
Когда отправил и ждет ответ от соседа — состояние ACTIVE.

Маршутизатор R1 отправляет TCP SYN на 179 порт BGP-пира и таким образом инициирует TCP сессию. 
R2  возвращает R1 TCP ACK (ответ на SYN R1) и посылает свой TCP SYN.
R1 возвращает R2 TCP ACK (о том, что получил SYN).

Итого — состояние установлено. 

<img width="406" height="26" alt="image" src="https://github.com/user-attachments/assets/b1598c37-33d1-49e0-ad7b-ef9a62a607eb" />

## А теперь переходим к настройке) 

### Топология

У меня подготовлена топология
<img width="841" height="730" alt="image" src="https://github.com/user-attachments/assets/62825a66-0913-437c-87eb-a29037ff8e24" />

Собственно мы видим следующее: 
1. У нас две AS (автономные системы)
2. Каждая из них использует внутри EIGRP протокол
3. Между собой они сообщаются при помощи BGP.

Для упрощения жизни правую частья я не запаривался с настройкой. 

Как настраивать EIGRP я уже показывал ранее в одной из записей в этом репозитории. Можете посмотреть.

Важным моментом будет только редистрибьюция и настройка метрики. 

Но для начала пойдем и настроим BGP.

### Настройка BGP

Подключаемся к роутеру R1
```
router bgp 100 !запускаем процесс BGP на маршрутизаторе с номером автономной системы 100
neighbor 192.168.1.2 remote-as 101 ! Определяем ip адрес соседего устройства (R2) и указываем номер AS соседа (101)
neighbor 192.168.1.2 update-source f0/0 ! Указываем с какого интерфейса будут отправляться BGP обновления (192.168.1.2 f0/0)
network 192.168.1.0 mask 255.255.255.0 ! Объявляем сеть, которую нужно  анонсировать через BGP
networ... повторяем для других сетей 
```

Собственно по аналогии делаем и для R2. 

### Что дальше? 

Как бы BGP настроили и че дальше? R1 и R2 друг друга пингует. Базару нет, между ними настроен BGP. Но возникает момент, что мы не для этого это делали. А для того, что бы другие роутеры могли через BGP пробрасывать информацию из EIGRP AS 100 в EIGRP AS 101. 

Для этого и того самого нужно настроить дистрибьюцию. Мы по сути BGP пиры понимают, что нужно взять и пробросить между собой EIGRP пакеты. 

Прото представим, что у нас по складу грузчики носят ящики. Они их грузят в машину, которая везет их на другой склад, там это дело распаковывают и передают дальше внутри склада. 

Ну если это плюс минус понятно, то давай пройдемся по командам:
```
 redistribute eigrp 100 metric 100 ! Мы пишем команду для перераспределения маршрутов из одного протокола в другой. 100 - номер AS EIGRP. Metric 100 - задаем метрику для перераспределяемых маршрутов в BGP
```
По аналогии делаем и для R2. 

Далее делаемм интерфейсы между R1 и R2 пассивными дял EIGRP, что бы между ними работал только BGP. 
```
router eigrp 100 ! Переходим к настройке процесса EIGRP
passive-interfae f0/0 ! Делаем интерфейс между R1 и R2 пассивным для EIGRP
```
По аналогии, естественно, делаем и для R2

Но и этого будет мало! Но осталось совсем чучуть, честно) 

Продолжаем работать с тем же EIGRP процессом:
```
rediistribute bgp 100 metric 10000 100 255 1 1500 ! Знакомая нам команда дистрибьюции, но уже BGP из AS 100. Идем к метрикам. 10000 - компонент пропускной способности, 100 - компонент задержки, 255 - надежность, 1 - загрузка, 1500 - MTU (максимальный размер пакета). Собственно, конкретные эти параметры мне подсказал Женёк, а ему - ИИ) 
```
И ты не поверишь - по аналогии делаем и для R2)) 

Вот и все, понеслась. Все пингуется и работает) 


