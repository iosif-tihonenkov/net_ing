# BGP и что это такое

## Историческая справка

Когда то давно в интернете было всего несколько AS (автономных систем). Ну это в те времена, когда всего абонентов могло быть сотня. И тогда все эти AS соединялись статичными маршрутами. Админилось это все еще более менее нормально. Но потом пришел прогресс и привел за собой большее кол-во абонентов и AS, в которых они вращались. И вот тут человечество совершило фатальную ошибку - начало интересоваться интернетом. Админить статичные маршруты становилось сложнее и для этого были придуманы протоколы динамической маршрутизации. Собственно, поехали.

## Что такое BGP? 

BGP, он же Border Gateway Protocol - это протокол граничного шлюза, предназначенный для обмена информацией о маршрутизации и доступности между различными AS (Автономными системами) в интернетах.

Если максимально взять просто - интернет - это сообщающиеся между собой AS, а BGP - это протокол, который их связывает. 
<img width="1179" height="686" alt="{29B3DB6C-C7AC-4007-842B-D3FA626415BF}" src="https://github.com/user-attachments/assets/3eb0c3d2-b84c-4d7b-954a-bb70f2efaee4" />


(На картинке показаны различные связи между AS. Но это не значит, что каждая AS подлючена к каждой напрямую. Наоборот, есть куча посредников. Просто на картинке я показал, что все сильно переплетено в этих ваших интернетах.

Для начала давайте разобьем BGP на две основные составляющие:

1. iBGP (internal) - для обмена маршрутами внутри AS;
2. eBGP (external) - для обмена маршрутами между AS.
   
<img width="1203" height="493" alt="{971D5D5E-8E5A-473D-A2FC-538CF7B4D450}" src="https://github.com/user-attachments/assets/e2210e82-8010-4182-a1e5-a871ecc7cf5f" />

## Как происходит коннект? 

1. BGP маршрутизатор инициирует утановление TCP-сессии (Transmission Control Protocol - [вот почитать, пока сам не написал об этом](https://gitverse.ru/blog/articles/architecture/405-v-chem-raznica-mezhdu-protokolami-tcp-i-udp)).
2. Обмен сообщениями. Когда TCP-сессия настроена успешна, маршрутизатор передает сообщение ```OPEN```, в котором сообщает свой ASN (Номер AS), RouterID (Идентификатор маршрутизатора) и Hold Timer (Время, в течении которого будет поддерживаться открытой данная TCP-сессия). Так же стоит добавить, что маршртизаторы кладут информацию по версии BGP, что бы нормально установить сессию. Сейчас стадарт - 4 версия, [почитать можно тут](https://en.wikipedia.org/wiki/Border_Gateway_Protocol#Uses). Возможно что то стоит в сообщение ```OPEN``` добавить, но для этого нужно поднять BGP-сессию и подцепить WireShark. Если это сообщение тут висит - значит у меня еще не дошли руки это расковырять)
3. Сообщение ```UPDATE```. Окей, после прошлого того, как маршрутизаторы упешно обменялись информацией в п.2, то они становятся соседями BGP. Теперь онни могут обмениваться информацией о маршрутизации. Делают они это с помощью сообщений ```UPDATE```. В это сообщение включается информация о доступности сетевого уровня, NLRI (Network Layer Reachabilty Information). Что еще можно найти в ```UPDATE```: Длина поля Wihtdrawn (если заполнено нулями - маршрутов на удаление нет), Withdrawn Routes - тут показываются все маршруты на удаление из таблицы BGP. Также добавим Path Attributes - атрибуты BGP для маршрута.
4. Сообщение ```KEEPALIVE```. По дефолту, BGP отправляет 19-байтовое сообщение ```KEEPALIVE``` каждую минуту (60 секунд). Если сосед пропустил три сообщения и не ответил - значит маршруты от такого соседа будут очищены. Походу этот сосед уже все, доработатался). То есть если кратко - проверка на существование соседа. Параметр настраиваемый.
5. Сообщение ```NOTIFICATION```. Здеь все просто - если что то идет не так и это ведет к обрыву сессии - маршрутизатор посылает это сообщение и рвет коннект. В сообщении будет указана также и ошибка, по которой он вас покинул. Расшифровка этих ошибок - [по ссылке на моем же гите)](https://github.com/iosif-tihonenkov/net_ing/blob/main/Настройки%20сети/BGP_notification_errors.md)

## Простая настройка

Будем настраивать между тремя маршрутизаторами. Каждый из них будет представлять из себя отдельную AS.

### Стартовые данные

Схема простая - R1 <-> R2 <-> R3 (Цепочка)

AS: 
1. R1: 64512
2. R2: 64513
3. R3: 64514

Интерфейсы и IP:
1. R1 к R2: 192.168.12.1/30 (e1/0);
2. R2 к R1: 192.168.12.2/30 (e1/0);
3. R2 к R3: 192.168.23.1/30 (e1/1);
4. R3 к R2: 192.168.23.2/30 (e1/0).

Чуть более наглядно - можно посмотреть на скриншоте:
<img width="864" height="307" alt="{C4F3D9B2-51F8-4DC5-8B3F-A8CDBBA0D7FD}" src="https://github.com/user-attachments/assets/11c6d881-c640-4187-af2f-41e7371ebeca" />

**Настройка R1:**
```
R1(config)#interface e1/0 !Переключаемся на настройку интерфейса e1/0 от R1 к R2
R1(config-if)#ip address 192.168.12.1 255.255.255.252 !Задаем интерфейсу ip-адрес и маску
R1(config-if)#no shutdown #!Включаем (подымаем) интерфейс
```
**Настройка R2:**

```
R2(config)#interface e1/0 !Переключаемся на настройку интерфейса e1/0 от R2 к R1
R2(config-if)#ip address 192.168.12.2 255.255.255.252 !Задаем интерфейсу ip-адрес и маску
R2(config-if)#no shutdown !Включаем (подымаем) интерфейс

R2(config)#interface e1/1 !Переключаемся на настройку интерфейса e1/1 от R2 к R3
R2(config-if)#ip address 192.168.23.1 255.255.255.252 !Задаем интерфейсу ip-адрес и маску
R2(config-if)#no shutdown !Включаем (подымаем) интерфейс
```

**Настройка R3:**

```
R3(config)#interface e1/0 !Переключаемся на настройку интерфейса e1/0 от R3 к R2
R3(config-if)#ip address 192.168.23.2 255.255.255.252 !Задаем интерфейсу ip-адрес и маску
R3(config-if)#no shutdown !Включаем (подымаем) интерфейс
```

## Настраиваем сам BGP:

**Настройка на R1:**

```
R1(config)#router bgp 64512 !Включаем BGP и указываем AS, за которую у нас отвечает этот маршрутизатор
R1(config-router)#bgp router-id 1.1.1.1 # !Указваем router ID (Не то, что бы это было прям нужно, но почему нет?)
R1(config-router)#neighbor 192.168.12.2 remote-as 64513 !Указываем сеть соседа (это у нас R2) и его AS
R1(config-router)#neighbor 192.168.12.2 description To_R2 !На всякий случай, от греха подальше - пишем описание. Написал я "К R2". Удобно, че.)
```
**Настройка на R2:**
```
R2(config)#router bgp 64513 
R2(config-router)#bgp router-id 2.2.2.2

R2(config-router)#neighbor 192.168.12.1 remote-as 64512 !Настраиваем связь с R1
R2(config-router)#neighbor 192.168.12.1 description To_R1

R2(config-router)#neighbor 192.168.23.2 remote-as 64514 !Настраиваем связь с R3
R2(config-router)#neighbor 192.168.23.2 description To_R3
```
**Настройка на R3:**
```
R3(config)#router bgp 64514
R3(config-router)#bgp router-id 3.3.3.3
R3(config-router)#neighbor 192.168.23.1 remote-as 64513 !Настраиваем связь с R2
R3(config-router)#neighbor 192.168.23.1 description To_R2
```



Заметка будет пополняться. Если не забью болт.... Последней пополнение - 09.11.2025.

Update: 
от 09.11.2025:
1. Заменил первый скриншот.
2. Чуть поправил термины и формулировки.
3. Добавил блок с простой настройкой (в процесе)

Планируемые блоки: 
1. Настройка BGP сессии: 4 AS, в каждой 3-и устройства.
2. Настройкка internal BGP
3. Добавить в блок "Как происходит коннект" скриншоты с WS.

